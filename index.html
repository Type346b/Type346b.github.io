<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>é«˜æ•°ç§¯åˆ†å…¬å¼è®°å¿†å·¥å…·</title>

  <!-- KaTeX æ ·å¼ & è„šæœ¬ï¼ˆdefer ä¿è¯å…ˆåŠ è½½å†æ‰§è¡Œæœ¬æ–‡è„šæœ¬ï¼‰-->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
  />
  <script
    defer
    src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"
  ></script>

  <style>
    /* ===== åŸºç¡€æ’ç‰ˆ ===== */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB",
        "Microsoft YaHei", sans-serif;
      background: linear-gradient(135deg, #f0f4ff, #e6f9ff);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #222;
    }
    h1 {
      margin: 0 0 20px;
      font-size: 1.8rem;
      text-align: center;
    }

    /* ===== å¸ƒå±€å®¹å™¨ ===== */
    .container {
      width: 90%;
      max-width: 640px;
      padding: 20px;
    }

    /* ===== å¡ç‰‡ ===== */
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 24px 20px;
      transition: transform 0.3s ease;
      margin-bottom: 24px;
    }
    .card:hover {
      transform: translateY(-4px);
    }
    .formula {
      font-size: 1.55rem;
      text-align: center;
      margin: 16px 0;
      word-break: break-word;
    }
    .hidden {
      display: none;
    }

    /* ===== æŒ‰é’®é€šç”¨ ===== */
    button {
      cursor: pointer;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 1rem;
      transition: transform 0.2s ease;
      color: #fff;
    }
    button:hover {
      transform: scale(1.06);
    }

    /* ===== äº¤äº’æŒ‰é’®é…è‰² ===== */
    #showAnswer {
      background: #2196f3;
      margin: 0 auto 14px auto;
      display: block;
      color: #fff;
    }
    .feedback-buttons {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .remember {
      background: #4caf50;
    }
    .vague {
      background: #ff9800;
    }
    .forget {
      background: #f44336;
    }

    /* ===== æ§åˆ¶æŒ‰é’® ===== */
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 24px;
    }
    .controls button {
      flex: 1 1 30%;
      background: #607d8b;
      color: #fff;
    }

    /* ===== è–„å¼±åˆ—è¡¨ ===== */
    #weaknessList {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    #weaknessList ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    #weaknessList li {
      margin: 12px 0;
    }

    /* ===== ç§»åŠ¨ç«¯å¾®è°ƒ ===== */
    @media (max-width: 480px) {
      .formula {
        font-size: 1.25rem;
      }
      button {
        font-size: 0.9rem;
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>é«˜ç­‰æ•°å­¦ç§¯åˆ†å…¬å¼è®°å¿†å·¥å…·</h1>

    <!-- ===== å…¬å¼å¡ç‰‡ ===== -->
    <div id="card" class="card">
      <div id="question" class="formula">ç‚¹å‡»ä¸‹æ–¹ â€œå¼€å§‹å¤ä¹ â€ â±</div>
      <div id="answer" class="formula hidden"></div>
      <button id="showAnswer" class="hidden">æ˜¾ç¤ºç­”æ¡ˆ</button>

      <div class="feedback-buttons hidden" id="feedbackGroup">
        <button class="remember" id="rememberBtn">æˆ‘è®°å¾—</button>
        <button class="vague" id="vagueBtn">æ¨¡ç³Š</button>
        <button class="forget" id="forgetBtn">ä¸è®°å¾—</button>
      </div>
    </div>

    <!-- ===== åŠŸèƒ½æŒ‰é’® ===== -->
    <div class="controls">
      <button id="startReview">å¼€å§‹å¤ä¹ </button>
      <button id="weaknessTraining">è–„å¼±ç‚¹å¼ºåŒ–</button>
      <button id="viewWeakness">æŸ¥çœ‹è–„å¼±ç‚¹</button>
    </div>

    <!-- ===== è–„å¼±å…¬å¼æ¸…å• ===== -->
    <div id="weaknessList" class="hidden"></div>
  </div>

  <script defer>
    /******************** 1. æ•°æ®ç»“æ„ ************************/
    /**
     * åˆå§‹ 20 æ¡å¸¸ç”¨ç§¯åˆ†å…¬å¼ï¼ˆquestion/answer ä¸º LaTeXï¼‰
     * åŠ å…¥ level / lastReviewed / nextReview / weak å±æ€§åä¼šå­˜å…¥ localStorage
     */
    const baseFormulas = [
      { id: 1, question: "\\int x^{n}\\,dx", answer: "\\frac{x^{n+1}}{n+1}+C" },
      { id: 2, question: "\\int \\sin x\\,dx", answer: "-\\cos x+C" },
      { id: 3, question: "\\int \\cos x\\,dx", answer: "\\sin x+C" },
      { id: 4, question: "\\int \\sec^{2}x\\,dx", answer: "\\tan x+C" },
      { id: 5, question: "\\int \\csc^{2}x\\,dx", answer: "-\\cot x+C" },
      { id: 6, question: "\\int \\sec x\\tan x\\,dx", answer: "\\sec x+C" },
      { id: 7, question: "\\int \\csc x\\cot x\\,dx", answer: "-\\csc x+C" },
      { id: 8, question: "\\int e^{ax}\\,dx", answer: "\\frac{1}{a}e^{ax}+C" },
      { id: 9, question: "\\int a^{x}\\,dx", answer: "\\frac{a^{x}}{\\ln a}+C" },
      { id: 10, question: "\\int \\frac{1}{x}\\,dx", answer: "\\ln|x|+C" },
      {
        id: 11,
        question: "\\int \\ln x\\,dx",
        answer: "x\\ln x - x + C",
      },
      { id: 12, question: "\\int \\tan x\\,dx", answer: "-\\ln|\\cos x|+C" },
      { id: 13, question: "\\int \\cot x\\,dx", answer: "\\ln|\\sin x|+C" },
      {
        id: 14,
        question: "\\int \\sec x\\,dx",
        answer: "\\ln|\\sec x + \\tan x|+C",
      },
      {
        id: 15,
        question: "\\int \\frac{1}{x^{2}+a^{2}}\\,dx",
        answer: "\\frac{1}{a}\\arctan\\left(\\frac{x}{a}\\right)+C",
      },
      {
        id: 16,
        question: "\\int \\frac{1}{\\sqrt{a^{2}-x^{2}}}\\,dx",
        answer: "\\arcsin\\left(\\frac{x}{a}\\right)+C",
      },
      { id: 17, question: "\\int \\sinh x\\,dx", answer: "\\cosh x + C" },
      { id: 18, question: "\\int \\cosh x\\,dx", answer: "\\sinh x + C" },
      {
        id: 19,
        question: "\\int x e^{ax}\\,dx",
        answer: "\\frac{e^{ax}}{a^{2}}(ax-1)+C",
      },
      {
        id: 20,
        question: "\\int \\frac{\\ln x}{x}\\,dx",
        answer: "\\tfrac{1}{2}(\\ln x)^{2}+C",
      },
    ];

    const STORAGE_KEY = "integralFormulaSRS";
    const MS_DAY = 86_400_000;

    /******************** 2. çŠ¶æ€åˆå§‹åŒ– / æŒä¹…åŒ– ************************/
    // å°† localStorage ä¸­çš„è¿›åº¦åˆå¹¶åˆ° baseFormulas
    const formulas = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    baseFormulas.forEach((f) => {
      const saved = formulas[f.id] || {};
      Object.assign(f, {
        level: saved.level ?? 0,
        lastReviewed: saved.lastReviewed ?? null,
        nextReview: saved.nextReview ?? Date.now(), // ç«‹å³å¯å¤ä¹ 
        weak: saved.weak ?? false,
      });
    });

    /** ä¿å­˜å½“å‰çŠ¶æ€åˆ° localStorage */
    const saveState = () => {
      const obj = {};
      baseFormulas.forEach((f) => {
        obj[f.id] = {
          level: f.level,
          lastReviewed: f.lastReviewed,
          nextReview: f.nextReview,
          weak: f.weak,
        };
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    };

    /******************** 3. DOM å·¥å…· ************************/
    const $ = (id) => document.getElementById(id);
    const questionEl = $("question");
    const answerEl = $("answer");
    const showAnswerBtn = $("showAnswer");
    const feedbackGroup = $("feedbackGroup");
    const weaknessListEl = $("weaknessList");

    /** ä½¿ç”¨ KaTeX æ¸²æŸ“ LaTeX å­—ç¬¦ä¸²åˆ°å…ƒç´  */
    function renderFormula(el, latex) {
      katex.render(latex, el, { throwOnError: false });
    }

    /******************** 4. SRS é˜Ÿåˆ—é€»è¾‘ ************************/
    let reviewQueue = []; // å½“å‰å¾…å¤ä¹ /å¼ºåŒ–çš„å…¬å¼æ•°ç»„
    let current = null; // å½“å‰æ˜¾ç¤ºçš„å…¬å¼
    let mode = "idle"; // "review" | "weak" | "idle"

    /** æ„å»ºåˆ°æœŸå¤ä¹ é˜Ÿåˆ—ï¼ˆlevel å‡åºä¼˜å…ˆï¼‰ */
    function buildReviewQueue() {
      const now = Date.now();
      reviewQueue = baseFormulas
        .filter((f) => f.nextReview <= now)
        .sort((a, b) => a.level - b.level);
    }

    /** æ„å»ºè–„å¼±ç‚¹è®­ç»ƒé˜Ÿåˆ— */
    function buildWeakQueue() {
      reviewQueue = baseFormulas.filter((f) => f.weak);
    }

    /** æ˜¾ç¤ºä¸‹ä¸€å¼ å¡ç‰‡ */
    function showNext() {
      current = reviewQueue.shift();
      if (!current) {
        // é˜Ÿåˆ—ä¸ºç©º
        questionEl.textContent =
          mode === "weak"
            ? "è–„å¼±ç‚¹å·²å…¨éƒ¨å·©å›ºï¼Œå¹²å¾—æ¼‚äº®ï¼ğŸ‰"
            : "æš‚æ— åˆ°æœŸå¤ä¹ å†…å®¹ï¼Œä¼‘æ¯ä¸€ä¸‹~";
        answerEl.classList.add("hidden");
        showAnswerBtn.classList.add("hidden");
        feedbackGroup.classList.add("hidden");
        return;
      }
      renderFormula(questionEl, current.question);
      renderFormula(answerEl, current.answer);
      answerEl.classList.add("hidden");
      showAnswerBtn.classList.remove("hidden");
      feedbackGroup.classList.add("hidden");
    }

    /******************** 5. åé¦ˆå¤„ç† (æ ¸å¿ƒ SRS) ************************/
    function recordFeedback(type) {
      if (!current) return;
      const now = Date.now();
      if (type === "remember") {
        current.level += 1;
        current.nextReview = now + MS_DAY * 2 ** current.level; // 1,2,4,8...
        current.weak = false;
      } else if (type === "vague") {
        current.level = Math.max(0, current.level - 1);
        current.nextReview = now + 4 * 60 * 60 * 1000; // 4 å°æ—¶
        current.weak = true;
      } else if (type === "forget") {
        current.level = 0;
        current.nextReview = now + 5 * 60 * 1000; // 5 åˆ†é’Ÿ
        current.weak = true;
      }
      current.lastReviewed = now;
      saveState();
      showNext();
    }

    /******************** 6. è–„å¼±ç‚¹æ¸…å• ************************/
    function renderWeaknessList() {
      const weakArr = baseFormulas.filter((f) => f.weak);
      if (!weakArr.length) {
        weaknessListEl.innerHTML = "<p>ç›®å‰æ²¡æœ‰è¢«æ ‡è®°ä¸ºè–„å¼±çš„å…¬å¼ ğŸ‰</p>";
        return;
      }
      const listHtml =
        "<h2>è–„å¼±ç‚¹æ¸…å•</h2><ul>" +
        weakArr
          .map(
            (f) =>
              `<li><span class="formula" id="q${f.id}"></span>
               <span> = </span>
               <span class="formula" id="a${f.id}"></span></li>`
          )
          .join("") +
        "</ul>";
      weaknessListEl.innerHTML = listHtml;

      // ä½¿ç”¨ KaTeX æ¸²æŸ“å…¬å¼
      weakArr.forEach((f) => {
        renderFormula(document.getElementById("q" + f.id), f.question);
        renderFormula(document.getElementById("a" + f.id), f.answer);
      });
    }

    /******************** 7. äº‹ä»¶ç»‘å®š ************************/
    // â€”â€”â€” æŒ‰é’®ï¼šæ˜¾ç¤ºç­”æ¡ˆ
    showAnswerBtn.addEventListener("click", () => {
      answerEl.classList.toggle("hidden");
      feedbackGroup.classList.toggle("hidden", !answerEl.classList.contains("hidden"));
    });

    // â€”â€”â€” åé¦ˆæŒ‰é’®
    $("rememberBtn").addEventListener("click", () => recordFeedback("remember"));
    $("vagueBtn").addEventListener("click", () => recordFeedback("vague"));
    $("forgetBtn").addEventListener("click", () => recordFeedback("forget"));

    // â€”â€”â€” å¼€å§‹å¤ä¹ 
    $("startReview").addEventListener("click", () => {
      mode = "review";
      buildReviewQueue();
      if (!reviewQueue.length) {
        alert("å½“å‰æ²¡æœ‰éœ€è¦å¤ä¹ çš„å…¬å¼ï¼Œç­‰åˆ°æœŸåå†æ¥å§ï¼");
        return;
      }
      weaknessListEl.classList.add("hidden");
      showNext();
    });

    // â€”â€”â€” è–„å¼±ç‚¹å¼ºåŒ–
    $("weaknessTraining").addEventListener("click", () => {
      mode = "weak";
      buildWeakQueue();
      if (!reviewQueue.length) {
        alert("æ²¡æœ‰æ ‡è®°ä¸ºè–„å¼±çš„å…¬å¼ï¼Œä¿æŒè‰¯å¥½çŠ¶æ€ï¼");
        return;
      }
      weaknessListEl.classList.add("hidden");
      showNext();
    });

    // â€”â€”â€” æŸ¥çœ‹è–„å¼±ç‚¹
    $("viewWeakness").addEventListener("click", () => {
      renderWeaknessList();
      weaknessListEl.classList.toggle("hidden");
    });

    // é¡µé¢åˆæ¬¡åŠ è½½ï¼šå¦‚æœæœ‰åˆ°æœŸå…¬å¼è‡ªåŠ¨æç¤º
    buildReviewQueue();
    if (reviewQueue.length) {
      questionEl.textContent = "æœ‰åˆ°æœŸå…¬å¼å¯å¤ä¹ ï¼Œç‚¹å‡» â€œå¼€å§‹å¤ä¹ â€ â±";
    }
  </script>
</body>
</html>
